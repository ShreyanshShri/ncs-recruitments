generator client {
  provider = "prisma-client"
  output   = "../app/generated/client"
}

datasource db {
  provider = "postgresql"
}

////////////////////
// ENUMS
////////////////////

enum Role {
  USER
  ADMIN
}

enum Domain {
  PROGRAMMING
  DEV
  DESIGN
  TECHNICAL
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  REJECTED
  SELECTED
}

enum RoundType {
  MCQ
  OFFLINE
}

enum SubmissionStatus {
  NOT_STARTED
  STARTED
  SUBMITTED
  EVALUATED
}

enum QuestionType {
  MCQ
  INPUT
}

enum RoundScope {
  COMMON
  DOMAIN
}

////////////////////
// AUTH
////////////////////

model User {
  id       String  @id @default(cuid())
  name     String?
  email    String  @unique
  password String?
  role     Role    @default(USER)

  applications Application[]

  createdAt   DateTime     @default(now())
  submissions Submission[]

  @@map("users")
}

////////////////////
// APPLICATION
////////////////////

model Application {
  id String @id @default(cuid())

  userId String
  domain Domain

  status ApplicationStatus @default(SUBMITTED)

  user        User         @relation(fields: [userId], references: [id])
  submissions Submission[]

  createdAt DateTime @default(now())

  @@unique([userId, domain]) // user can apply once per domain
}

////////////////////
// ROUNDS
////////////////////

model Round {
  id String @id @default(cuid())

  scope  RoundScope
  domain Domain?
  order  Int

  type  RoundType
  title String

  isActive    Boolean   @default(false)
  isPublished Boolean   @default(false)
  publishedAt DateTime?

  startTime DateTime?
  endTime   DateTime?

  cutoff   Float?
  maxScore Float?

  markingScheme Json?

  submissions Submission[]
  questions   Question[]

  createdAt DateTime @default(now())

  @@unique([domain, order]) // prevents duplicate positions
}

////////////////////
// MCQ QUESTIONS
////////////////////

model Question {
  id      String @id @default(cuid())
  roundId String

  question String

  type QuestionType

  options Json? // only used for MCQ

  answer String
  marks  Float

  round Round @relation(fields: [roundId], references: [id])
}

////////////////////
// SUBMISSIONS
////////////////////

model Submission {
  id String @id @default(cuid())

  roundId String

  userId        String? // ⭐ NEW
  applicationId String? // ⭐ make optional

  status SubmissionStatus @default(NOT_STARTED)

  score     Float?
  responses Json?

  user        User?        @relation(fields: [userId], references: [id])
  application Application? @relation(fields: [applicationId], references: [id])
  round       Round        @relation(fields: [roundId], references: [id])

  evaluatedBy String?

  createdAt DateTime @default(now())

  @@unique([applicationId, roundId])
  @@unique([userId, roundId]) // ⭐ prevents duplicate COMMON submissions
}
